<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>寄递通关管理系统</title>
<link href="common.css" rel="stylesheet" type="text/css" />
<style type="text/css">
* {
	margin: 0;
	padding: 0;
	border: 0;
	font-size: 12px;
	font-family: Tahoma, Verdana, 宋体;
}

html, body {
	width: 100%;
	height: 100%;
	overflow: hidden;
}

.head-bar {
	padding: 0 6px 0 6px;
	border-top: 1px solid #A9ACB5;
	background: #EBEDF2;
	height: 23px;
	line-height: 23px;
	overflow: hidden;
}

#lblUser {
	float: right;
}
</style>
</head>
<body>
	<ul id="menu" class="nui-menubar" onitemclick="onItemClick"
		textField="menuName" idField="menuNo" parentField="menuParentNo"
		style="border: 0;">
	</ul>
	<div class="head-bar">
		<label id="lblTitle">欢迎</label><label id="lblUser"></label>
	</div>
		<div class="nui-fit">
			<iframe id="workArea" border="0" frameborder="0" marginheight="0"
				marginwidth="0" style="width: 100%; height: 100%;"></iframe>
		</div>
	<div style="height: 13px; line-height: 14px; text-align: center; overflow: hidden;">全国海关信息中心 &nbsp; &copy; 版权所有</div>

	<script type="text/javascript" src="nui/nui.js"></script>
	<script type="text/javascript" src="common.js"></script>
	<script type="text/javascript">
		/* 定义——开始 */
		nui.parse();//将html转换为nui控件
		var user = null;
		
		//菜单点击事件
		function onItemClick(e) {
			var item = e.item;
			var isLeaf = e.isLeaf;
			if (isLeaf) {// 叶子节点响应点击
				$("#workArea").attr("src", item.menuUrl);// 设置ifame的src属性为指定页面
				$("#lblTitle").text(item.menuDesc);//菜单描述作为页面标题
			}
		}
		// 根据指定用户生成导航菜单
		function createMenu(user) {
			var json = nui.encode(user);
			main.ajax("account/getMenus.do", json, menuCallback, null,
					null, "application/json");//contentType:"application/json",// *必须写*
		}
		//获取菜单成功时的回调函数
		function menuCallback(list) {// 菜单JSON规则：id、text、url、pid
			//给菜单绑定数据源
			nui.get("menu").loadList(list, "menuNo", "menuParentNo");//菜单集合，ID字段名，父ID字段名
		}
		//获取窗口高度
		function windowHeight() {
			var de = document.documentElement;
			return (de && de.clientHeight);
		}
		//获取窗口宽度
		function windowWidth() {
			var de = document.documentElement;
			return (de && de.clientWidth);
		}
		// 最大化浏览器窗口
		function maximizeWindow() {
			// if (navigator.userAgent.indexOf("msie") > 0)
			if (/msie/.test(navigator.userAgent.toLowerCase())) {
				window.moveTo(0, 0);
				window.resizeTo(screen.availWidth, screen.availHeight);
			}
			/*
			 * else if(navigator.userAgent.indexOf("Firefox") > 0){
			 * window.moveTo(0, 0); window.resizeTo(screen.availWidth,
			 * screen.availHeight); }
			 */
		}
		//初始化入口方法
		function mainInit(user) {
			if (user) {
				// 显示当前用户
				$("#lblUser").text(user.allPathName);
				// 加载导航菜单
				createMenu(user);
			}
		}
		
		//声明一个全局变量
		main = {};
		//确认对话框
		main.showConfirm = function(text, title, callback) {
			if (!title) {
				title = "确认";
			}
			nui.confirm(text, title, callback)
		}
		//信息对话框TODO
		main.showInfo = function(text, title, callback) {
			if (!title) {
				title = "信息";
			}
			nui.alert(text, title, callback);
		}
		//警告对话框TODO
		main.showWarning = function(text, title, callback) {
			if (!title) {
				title = "警告";
			}
			nui.alert(text, title, callback);
		}
		//错误对话框TODO
		main.showError = function(text, title, callback) {
			if (!title) {
				title = "错误";
			}
			nui.alert(text, title, callback);
		}

		// 封装ajax调用，main.ajax(url,data,success,error,dataType,type)
		// 给全局对象声明方法
		/*
		 * url：需要请求的地址
		 * data：需要传递的参数
		 * success：成功时的回调函数
		 * error：失败时的回调函数
		 * dataType：参数类型
		 * contentType：期望返回类型
		 * type：POST或GET
		 * async:true代表异步，false代表同步
		 * */
		main.ajax = function(url, data, success, error, dataType, contentType, type, async) {
			// 调用$.ajax()
			$.ajax({
				url : url,
				data : data,
				success : success,
				error : error,
				dataType : dataType,
				contentType : contentType,
				type : type,
				async: async
			});
		};
		
		// ajax初始化
		function initAjax() {
			var msgId;
			$.ajaxSetup({
				type : "POST",
				async : true,
				/*以下两项注释掉，否则传参、接收都有问题……
				dataType : "json",
				contentType : "application/json",
				*/
				beforeSend : function() {//显示等待窗体
					msgId = nui.loading("加载中……");
				},
				success : function(result) {
					//nui.alert("default success");
				},
				error : function(e) {//失败时的默认回调函数
					//nui.alert("default error");
					//统一使用main.html定义的提示方法
					if (e.status == 401) {
						main.showError(e.responseText);
					} else if (e.status == 499) {
						main.showError(e.responseText, null, closeMyself);
					} else if (e.status == 599) {
						main.showError(e.responseText);
					} else {
						main.showError(e.responseText);
					}
				},
				complete : function() {//隐藏等待窗体
					nui.hideMessageBox(msgId);
				}
			});
		}
		/* 定义——结束 */

		/* 页面初始化——开始 */
		$(function() {
			initAjax();
			maximizeWindow();
			if (window.opener && window.opener.user){
				mainInit(window.opener.user);
			} else {
				main.showWarning("请重新启动本系统！", null, closeMyself);
			}
			/*
			// 获取兼职信息
			var userList = null;
			main.ajax("main/queryPruralityInfo.do", null, function(result){userList=result;}, null, null, "application/json", "POST", false);
			//用户集合为空时，结束
			if (!userList || userList.length == 0) {
				return;
			}
			//只有一个职位，直接初始化
			if (userList.length == 1) {
				mainInit(userList[0]);
			} else {//存在多个职位，弹出职位选择子页面，选择一个职位后，由子页面调用主页面的mainInit(user)方法进行初始化
				nui.open({
					url : "logon.html", //页面地址
					title : "职位选择", //标题
					//iconCls: String,//标题图标
					width : 400, //宽度
					height : 300, //高度
					allowResize : false, //允许尺寸调节
					allowDrag : false, //允许拖拽位置
					showCloseButton : false, //显示关闭按钮
					showMaxButton : false, //显示最大化按钮
					showModal : true, //显示遮罩
					loadOnRefresh : false, //true每次刷新都激发onload事件
					onload : function() { //“弹出页面”加载完成
						//nui.alert("onload");
						var iframe = this.getIFrameEl();//获取open方法生成的iframe元素
						iframe.contentWindow.setData(userList);//调用“弹出页面”的方法进行初始化，传递用户集合
					},
					ondestroy : function(action) { //“弹出页面”关闭
						//nui.alert(action);
						if (action == "cancel") {//如果在职位选择页面点击了取消按钮，则同时关闭主页面
							window.close();
						}
					}
				});
			}
			*/
		});
		/* 页面初始化——结束 */
	</script>
	<style type="text/css">
	.mini-menu-border {
		border: 0;
	}

	.mini-menu-horizontal .mini-menu-inner {
		padding: 0;
	}
	</style>
</body>
</html>